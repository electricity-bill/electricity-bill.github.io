<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>Electricity Bill</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Global SVG sprite (define once, reuse everywhere) -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">
    <defs>
      <symbol id="icon-bulb" viewBox="0 0 24 24">
        <path fill="currentColor" d="M9 21h6v-1H9zm3-19a7 7 0 0 0-4.9 11.9c.6.6 1.1 1.4 1.3 2.3l.1.3h7l.1-.3c.2-.9.7-1.7 1.3-2.3A7 7 0 0 0 12 2m0 2a5 5 0 0 1 3.5 8.5c-.9.9-1.5 2-1.8 3.2h-3.4c-.3-1.2-.9-2.3-1.8-3.2A5 5 0 0 1 12 4"/>
      </symbol>
    </defs>
  </svg>

  <h1 class="mainHeading" id="mainHeading"></h1>
  <div class="wrapper">
    <div class="form_container">
      <form name="form" id="userForm" novalidate>
        <div class="heading">
          <h2>Electricity Bill Calculator</h2>
        </div>

        <div class="form_wrap">
          <div class="form_item">
            <label for="totalUnits">Total Electricity Units (kWh)</label>
            <input type="number" id="totalUnits" name="totalUnits" inputmode="decimal" min="0.01" step="0.01" required />
          </div>
        </div>

        <div class="form_wrap">
          <div class="form_item">
            <label for="totalBill">Total Electricity Bill (₹)</label>
            <input type="number" id="totalBill" name="totalBill" inputmode="decimal" min="0.01" step="0.01" required />
          </div>
        </div>

        <div class="form_wrap">
          <div class="form_item">
            <label for="buildUnits">Your Consumption (kWh)</label>
            <input type="number" id="buildUnits" name="buildUnits" inputmode="decimal" min="0" step="0.01" required />
          </div>
        </div>

        <div class="btn">
          <input id="btn" type="submit" value="Calculate" />
        </div>
      </form>

      <div id="app" role="status" aria-atomic="true"></div>
    </div>
  </div>

  <div id="fallbackOverlay" class="fallback-overlay" aria-hidden="true"></div>

  <script>
    const url = new URL(window.location.href);

    // Params
    const tenantNameParam = url.searchParams.get('tenant');
    const totalUnitsParam = url.searchParams.get('units');
    const totalBillParam = url.searchParams.get('bill');
    const buildUnitsParam = url.searchParams.get('consumption');
    const mainHeading = document.getElementById("mainHeading");

    if (tenantNameParam !== null) {
      mainHeading.innerHTML = `Welcome ${String(tenantNameParam).charAt(0).toUpperCase() + String(tenantNameParam).slice(1)} Ji!`;
    } else {
      mainHeading.innerHTML = `Welcome Tenant!`;
    }

    (function () {
      const form = document.getElementById('userForm');
      const totalUnitsEl = document.getElementById('totalUnits');
      const totalBillEl  = document.getElementById('totalBill');
      const buildUnitsEl = document.getElementById('buildUnits');

      // Prefill values only if params are present
      if (totalUnitsParam !== null && totalUnitsEl) totalUnitsEl.value = totalUnitsParam;
      if (totalBillParam  !== null && totalBillEl)  totalBillEl.value  = totalBillParam;
      if (buildUnitsParam !== null && buildUnitsEl) buildUnitsEl.value = buildUnitsParam;

      const app = document.getElementById('app');
      const fallbackOverlay = document.getElementById('fallbackOverlay');

      function parseNum(v) {
        return Number(String(v).replace(/[₹,\s]/g, ''));
      }

      function validateCrossFields() {
        const tu = parseNum(totalUnitsEl.value);
        const bu = parseNum(buildUnitsEl.value);
        buildUnitsEl.setCustomValidity('');
        if (Number.isFinite(tu) && Number.isFinite(bu) && bu > tu) {
          buildUnitsEl.setCustomValidity('Consumption must be less than or equal to total units.');
        }
      }

      form.addEventListener('input', validateCrossFields);

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        validateCrossFields();
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const totalUnits = parseNum(totalUnitsEl.value);
        const totalBill  = parseNum(totalBillEl.value);
        const buildUnits = parseNum(buildUnitsEl.value);

        const averageUnits = totalBill / totalUnits;
        const yourShare = buildUnits / totalUnits;
        const result = (totalBill * buildUnits) / totalUnits;

        const summaryText = [
          `Your respective share: ${yourShare.toFixed(2)}`,
          `Consumption: ${buildUnits.toFixed(2)} kWh`,
          `Payable amount: ₹${result.toFixed(2)}`
        ].join('\n');

        app.innerHTML = `
          <section class="summary-card panel" aria-labelledby="sum-title">
            <div class="summary-header">
              <div class="summary-title">
                <h3 id="sum-title">Summary</h3>
                <button
                  type="button"
                  class="icon-btn hint"
                  id="hintBtn"
                  aria-label="Show calculation details"
                  aria-expanded="false"
                  popovertarget="calc-pop">
                  <svg width="30" height="30" aria-hidden="true" focusable="false">
                    <use href="#icon-bulb"></use>
                  </svg>
                </button>
              </div>
              <div class="summary-actions">
                <button type="button" id="copySummary" class="action-btn">Copy</button>
                <button type="button" id="printSummary" class="action-btn">Print</button>
              </div>
            </div>

            <dl class="stats-grid">
              <div class="stat">
                <dt>Your Share</dt>
                <dd>${(buildUnits/totalUnits).toFixed(4)}</dd>
              </div>
              <div class="stat">
                <dt>Total bill</dt>
                <dd>₹${totalBill.toFixed(2)}</dd>
              </div>
              <div class="stat">
                <dt>Consumption</dt>
                <dd>${buildUnits.toFixed(2)} kWh</dd>
              </div>
              <div class="stat accent result-stats-grid">
                <dt>Payable amount</dt>
                <dd>₹${result.toFixed(2)}</dd>
              </div>
            </dl>

            <p id="sum-live" class="visually-hidden" aria-live="polite"></p>
          </section>

          <div id="calc-pop" popover class="panel popover-card" aria-labelledby="exp-title">
            <div class="popover-header">
              <h3 id="exp-title">Calculation</h3>
              <div>
                <button
                  id="langToggle"
                  class="action-btn"
                  type="button"
                  aria-controls="exp-en exp-hi"
                  aria-label="Switch to Hindi">
                  Hindi
                </button>
                <button
                  type="button"
                  class="action-btn close-btn"
                  aria-label="Close details"
                  popovertarget="calc-pop"
                  popovertargetaction="hide">✕</button>
              </div>
            </div>
            <div class="popover-inner">
              <p class="hint hint-engraved">Press the button above to switch between English and Hindi.</p>
              <div class="content">
                <div id="exp-en" lang="en">
                  <p>
                    1. Calculate Your Share of the Total Units:<br>
                    You consumed <span class="var">${buildUnits.toFixed(2)}</span> units out of <span class="var">${totalUnits.toFixed(2)}</span> units.<br>
                    Your Share (Ratio): <span class="var">${buildUnits.toFixed(2)} ÷ ${totalUnits.toFixed(2)} = ${yourShare.toFixed(5)}</span>
                  </p>
                  <p>
                    2. Apply this share to the full bill:<br>
                    <span class="var">${yourShare.toFixed(5)} × ₹${totalBill.toFixed(2)} = ₹${result.toFixed(2)}</span>
                  </p>
                </div>

                <div id="exp-hi" lang="hi" hidden>
                  <p>
                    1. कुल यूनिट में से अपने हिस्से की गणना करें:<br>
                    आपने <span class="var">${totalUnits.toFixed(2)}</span> में से <span class="var">${buildUnits.toFixed(2)}</span> की खपत की।<br>
                    आपका हिस्सा (अनुपात): <span class="var">${buildUnits.toFixed(2)} ÷ ${totalUnits.toFixed(2)} = ${yourShare.toFixed(5)}</span>
                  </p>
                  <p>
                    2. अब, इस हिस्से को पूरे बिल पर लगाएँ:<br>
                    <span class="var">${yourShare.toFixed(5)} × ₹${totalBill.toFixed(2)} = ₹${result.toFixed(2)}</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        `;

        // Swap ticker from pre-calc to post-calc after successful calculation
        const pre = document.getElementById('tickerPre');
        const post = document.getElementById('tickerPost');
        if (pre) pre.hidden = true;
        if (post) post.hidden = false;

        const copyBtn = document.getElementById('copySummary');
        const printBtn = document.getElementById('printSummary');
        const live = document.getElementById('sum-live');

        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(summaryText);
            live.textContent = 'Summary copied to clipboard.';
          } catch {
            const ta = document.createElement('textarea');
            ta.value = summaryText;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            live.textContent = 'Summary copied.';
          }
        });

        printBtn.addEventListener('click', () => {
          window.print();
          live.textContent = 'Print dialog opened.';
        });

        // Language toggle inside popover
        const btn = document.getElementById('langToggle');
        const en = document.getElementById('exp-en');
        const hi = document.getElementById('exp-hi');

        function applyLang(showHindi) {
          en.hidden = !!showHindi;
          hi.hidden = !showHindi;
          if (showHindi) {
            btn.textContent = 'English';
            btn.setAttribute('aria-label', 'Switch to English');
            try { localStorage.setItem('calcLang', 'hi'); } catch {}
          } else {
            btn.textContent = 'हिन्दी';
            btn.setAttribute('aria-label', 'Switch to Hindi');
            try { localStorage.setItem('calcLang', 'en'); } catch {}
          }
        }
        try {
          const saved = localStorage.getItem('calcLang');
          applyLang(saved === 'hi');
        } catch { applyLang(false); }

        btn.addEventListener('click', () => {
          const showingHindi = !hi.hidden;
          applyLang(!showingHindi);
        });

        // Popover state → glow on hint button
        const pop = document.getElementById('calc-pop');
        const hintBtn = document.getElementById('hintBtn');
        const supportsPopover = 'showPopover' in HTMLElement.prototype;

        if (supportsPopover) {
          pop.addEventListener('toggle', () => {
            const open = pop.matches(':popover-open');
            hintBtn.classList.toggle('is-active', open);
            hintBtn.setAttribute('aria-expanded', String(open));
          });
        } else {
          // Fallback centered modal
          const modal = document.createElement('div');
          modal.className = 'fallback-modal';
          while (pop.firstChild) modal.appendChild(pop.firstChild);
          document.body.appendChild(modal);
          pop.remove();

          const openFallback = () => {
            modal.classList.add('is-open');
            fallbackOverlay.classList.add('is-open');
            hintBtn.classList.add('is-active');
            hintBtn.setAttribute('aria-expanded', 'true');
          };
          const closeFallback = () => {
            modal.classList.remove('is-open');
            fallbackOverlay.classList.remove('is-open');
            hintBtn.classList.remove('is-active');
            hintBtn.setAttribute('aria-expanded', 'false');
          };

          hintBtn.removeAttribute('popovertarget');
          hintBtn.addEventListener('click', openFallback);
          fallbackOverlay.addEventListener('click', closeFallback);

          const closeBtn = modal.querySelector('.close-btn');
          if (closeBtn) closeBtn.addEventListener('click', closeFallback);
          window.addEventListener('keydown', (ev) => {
            if (ev.key === 'Escape') closeFallback();
          }, { passive: true });
        }
      });
    })();
  </script>

  <!-- Ticker (pre-calc + post-calc), placed just BEFORE footer -->
  <div class="ticker" aria-live="off" aria-label="Information ticker">
    <!-- PRE-CALC: visible on load -->
    <div class="ticker__inner" id="tickerPre">
      <!-- Group 1 -->
      <div class="ticker__group">
        <span class="ticker__item" lang="en">Press Calculate to check your bill amount</span>
        <span class="ticker__item" lang="hi">बिल राशि देखने के लिए 'Calculate' दबाएँ</span>
      </div>
      <!-- Group 2 (duplicate for seamless loop) -->
      <div class="ticker__group" aria-hidden="true">
        <span class="ticker__item" lang="en">Press Calculate to check your bill amount</span>
        <span class="ticker__item" lang="hi">बिल राशि देखने के लिए 'Calculate' दबाएँ</span>
      </div>
    </div>

    <!-- POST-CALC: hidden until after calculation -->
    <div class="ticker__inner" id="tickerPost" hidden>
      <!-- Group 1 -->
      <div class="ticker__group">
        <span class="ticker__item" lang="en">
          For more information click
          <button type="button" class="icon-btn hint ticker-hint-btn" aria-label="More information">
            <svg width="28" height="28" aria-hidden="true" focusable="false">
              <use href="#icon-bulb"></use>
            </svg>
          </button>
        </span>
        <span class="ticker__item" lang="hi">
          अधिक जानकारी के लिए
          <button type="button" class="icon-btn hint ticker-hint-btn" aria-label="अधिक जानकारी">
            <svg width="28" height="28" aria-hidden="true" focusable="false">
              <use href="#icon-bulb"></use>
            </svg>
          </button>
          पर क्लिक करें
        </span>
      </div>

      <!-- Group 2 (duplicate for seamless loop) -->
      <div class="ticker__group" aria-hidden="true">
        <span class="ticker__item" lang="en">
          For more information click
          <button type="button" class="icon-btn hint ticker-hint-btn" aria-label="More information">
            <svg width="28" height="28" aria-hidden="true" focusable="false">
              <use href="#icon-bulb"></use>
            </svg>
          </button>
        </span>
        <span class="ticker__item" lang="hi">
          अधिक जानकारी के लिए
          <button type="button" class="icon-btn hint ticker-hint-btn" aria-label="अधिक जानकारी">
            <svg width="28" height="28" aria-hidden="true" focusable="false">
              <use href="#icon-bulb"></use>
            </svg>
          </button>
          पर क्लिक करें
        </span>
      </div>
    </div>
  </div>

  <!-- Ticker JS: open popover if present, otherwise scroll to form/summary -->
  <script>
    (function () {
      const onTickerClick = () => {
        const pop = document.getElementById('calc-pop');
        const supportsPopover = 'showPopover' in HTMLElement.prototype;
        if (pop && supportsPopover) {
          try { pop.showPopover(); return; } catch {}
        }
        // If popover hasn't been created yet (no calculation), scroll to summary or form
        const sum = document.getElementById('sum-title');
        if (sum) { sum.scrollIntoView({ behavior: 'smooth', block: 'center' }); return; }
        const form = document.getElementById('userForm');
        if (form) form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      };

      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.ticker-hint-btn');
        if (!btn) return;
        onTickerClick();
      }, { passive: true });
    })();
  </script>

  <footer class="site-footer" role="contentinfo">
    <p>© 2025 Dheeraj Pant. All rights reserved.</p>
  </footer>
</body>
</html>
